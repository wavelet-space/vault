<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <title>Document</title>
</head>

<body>
    <canvas id="canvas"></canvas>
</body>
<script>
    //let metaData = {
    //   information:"",
    //   symbol:"",
    //   lastRefresh:"",
    //   outputSize:"",
    //   timeZone:""
    // }


    function getTimeslots(width, ohlc) {
        let count = width / ohlc.length;
        return count;
    }


    let drawLine = (ctx, x, y, style = undefined) => {
        ctx.beginPath();
        if (style) {
            ctx.strokeStyle = style
        }
        ctx.moveTo(x[0], x[1]);
        ctx.lineTo(y[0], y[1]);
        ctx.stroke();
    }

    /**
    * 0 time
    * 1 open
    * 2 high
    * 3 low
    * 4 close
    */
    function drawCandles(ctx, width, ohlc, dateRange, lp, hp, steps) {
        let timeSlot = getTimeslots(width, ohlc);
        let idx = 0;
        const calculatePosition = (price) => {
            let maxPx = info.yMax[1]
            let x = maxPx - ((price - lp) / (hp - lp) * maxPx)
            return x;
        }
        for (var candle of ohlc) {
            let [open, high, low, close] = candle.slice(1)
            // console.log(open, high, low, close)

            // Y axis value for each price point.
            let openPosition = Math.floor(calculatePosition(open));
            let lowPosition = Math.floor(calculatePosition(low));
            let highPosition = Math.floor(calculatePosition(high));
            let closePosition = Math.floor(calculatePosition(close));

            // Pixel for candle center along X axis.
            let currentStep = Math.floor(idx * timeSlot);

            if (openPosition > closePosition) { // x,y,w,h
                console.log(currentStep)
                let height = openPosition - closePosition;
                ctx.fillStyle = "red";
                ctx.fillRect(currentStep - 5, closePosition, 10, height);
                drawLine(ctx, [currentStep, lowPosition], [currentStep, highPosition], "red");
                ctx.strokeStyle = "black"
                ctx.beginPath();
                ctx.rect(currentStep - 5, closePosition, 10, height);
                ctx.stroke();
            } else {
                let height = closePosition - openPosition;
                ctx.fillStyle = "green";
                ctx.fillRect(currentStep - 5, openPosition, 10, height);
                drawLine(ctx, [currentStep, lowPosition], [currentStep, highPosition], "green");
                ctx.strokeStyle = "black"
                ctx.beginPath();
                ctx.rect(currentStep - 5, openPosition, 10, height);
                ctx.stroke();
            }
            candleOhlcMappings.push({
                idx: idx,
                step: currentStep,
                positions: {
                    openPosition: openPosition,
                    lowPosition: lowPosition,
                    highPosition: highPosition,
                    closePosition: closePosition
                }
            });
            idx++;
        }
    }

    /** CALCULATE AMOUNT OF ROWS TO FIT IN GRID */
    function calculateSteps(w, h, xLines, yLines, info) {
        //calculate horizontal lines across the Y axis
        let yDist = h / xLines;
        let yStep = yDist;
        let ySteps = [yStep];
        let yCount = 0;

        while (yCount != xLines) {
            yCount++
            yStep += yDist;
            ySteps.push(Math.floor(yStep));
        }

        //calculate vertical lines along the X axis
        let xDist = w / yLines;
        let xStep = xDist;
        let xSteps = [xStep];

        let xCount = 0;

        while (xCount < yLines) {
            xCount++;
            xStep += xDist;
            xSteps.push(Math.floor(xStep));
        }
        
        info.yMin = [0, 0]
        info.yMax = [0, ySteps[ySteps.length - 1]];
        info.xMin = [0, 0];
        info.xMax = [xSteps[xSteps.length - 1], 0];

        return [xSteps, ySteps];
    }

    function drawGrid(ctx, width, height, xLines, lp, hp, dateRange) {
        let drawHorizontal = (yPoints) => {
            drawLine([0, 0], [width, 0]);
            for (var point of yPoints) {
                drawLine(ctx, [0, point], [width, point], "grey")
            }
        }
        let drawVertical = (xPoints) => {
            drawLine([0, 0], [0, height]);

            for (var point of xPoints) {
                drawLine([point, height], [point, 0], "grey")
            }
        }
        let steps = calculateSteps(width, height, xLines);
        drawVertical(steps[0])
        drawHorizontal(steps[1])
        return steps;
    }

    function drawInfo(ctx, w, h, mousePos) {
        drawLine([0, mousePos.y], [w, mousePos.y], "black");
        drawLine([mousePos.x, 0], [mousePos.x, h], "black");
    }

    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }

    (function () {
        // split the data set into ohlc and volume
        var volume = [];
        let hp = 0;
        let lp = 100
        let dateRange = ["", ""];
        // let addEvent = () => {
        //     let state = "loading";
        //     canvas.addEventListener('mousemove', function (evt) {
        //         if (state == "progress") {
        //             return;
        //         }
        //                   state == "progress";
        //                   var mousePos = getMousePos(canvas, evt);
        //                   var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;


        //                   var img = new Image();
        //                   img.onload = function () {
        //                     ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        //                   }
        //                   img.src = dataUri;
        //                   drawInfo(mousePos);
        //                   state == "finished";
        //     }, false);
        // }
        // setTimeout(addEvent, 500);
  
        data = [
            { "id": "230864", "company_id": "10", "date": "2015-01-28", "open": "17.1", "close": "17.2", "high": "17.4", "low": "17.1", "volume": "4907" },
            { "id": "238988", "company_id": "10", "date": "2015-01-27", "open": "17.2", "close": "17.4", "high": "17.5", "low": "17.2", "volume": "20992" },
            { "id": "249298", "company_id": "10", "date": "2015-01-26", "open": "17.6", "close": "17.4", "high": "17.6", "low": "17.2", "volume": "17030" },
            { "id": "253925", "company_id": "10", "date": "2015-01-25", "open": "17.5", "close": "17.6", "high": "17.8", "low": "17.5", "volume": "11873" },
            { "id": "153495", "company_id": "10", "date": "2015-01-22", "open": "18", "close": "17.8", "high": "18.5", "low": "17.5", "volume": "41292" },
            { "id": "161899", "company_id": "10", "date": "2015-01-21", "open": "17.2", "close": "17.4", "high": "17.5", "low": "17.2", "volume": "12924" },
            { "id": "169636", "company_id": "10", "date": "2015-01-20", "open": "17.5", "close": "17.3", "high": "18", "low": "17.3", "volume": "23267" },
            { "id": "178827", "company_id": "10", "date": "2015-01-19", "open": "18.3", "close": "17.5", "high": "18.3", "low": "17.4", "volume": "213588" },
            { "id": "188876", "company_id": "10", "date": "2015-01-18", "open": "18.5", "close": "18.6", "high": "18.8", "low": "18.4", "volume": "4044" },
            { "id": "39083", "company_id": "10", "date": "2015-01-15", "open": "18.5", "close": "18.7", "high": "18.8", "low": "18.5", "volume": "55008" },
            { "id": "4230", "company_id": "10", "date": "2015-01-14", "open": "18.5", "close": "18.7", "high": "18.9", "low": "18.3", "volume": "26539" },
            { "id": "124970", "company_id": "10", "date": "2015-01-13", "open": "19.1", "close": "18.6", "high": "19.1", "low": "18.5", "volume": "33115" },
            { "id": "134910", "company_id": "10", "date": "2015-01-12", "open": "18.5", "close": "18.7", "high": "18.9", "low": "18.5", "volume": "5952" },
            { "id": "111812", "company_id": "10", "date": "2015-01-11", "open": "18.4", "close": "18.8", "high": "18.8", "low": "18.4", "volume": "12269" },
            { "id": "103733", "company_id": "10", "date": "2015-01-08", "open": "18.3", "close": "18.4", "high": "20", "low": "18", "volume": "71995" },
            { "id": "45334", "company_id": "10", "date": "2015-01-07", "open": "18.6", "close": "19.2", "high": "19.7", "low": "18.6", "volume": "12924" },
            { "id": "54152", "company_id": "10", "date": "2015-01-06", "open": "18.5", "close": "18.9", "high": "19.3", "low": "18.5", "volume": "10339" },
            { "id": "63430", "company_id": "10", "date": "2015-01-05", "open": "18.7", "close": "18.8", "high": "18.9", "low": "18.7", "volume": "7327" },
            { "id": "32878", "company_id": "10", "date": "2015-01-01", "open": "18.6", "close": "18.8", "high": "19.1", "low": "18.6", "volume": "2807" },
            { "id": "203982", "company_id": "10", "date": "2014-12-30", "open": "18.3", "close": "18.7", "high": "19.4", "low": "18.3", "volume": "11798" },
            { "id": "213641", "company_id": "10", "date": "2014-12-29", "open": "18.3", "close": "18.6", "high": "18.6", "low": "18.3", "volume": "22364" },
            { "id": "221670", "company_id": "10", "date": "2014-12-28", "open": "18.2", "close": "18.8", "high": "19.2", "low": "18.2", "volume": "7142" },
            { "id": "255270", "company_id": "10", "date": "2014-12-24", "open": "18.6", "close": "18.8", "high": "19", "low": "18.5", "volume": "17440" },
            { "id": "264715", "company_id": "10", "date": "2014-12-23", "open": "18.3", "close": "18.9", "high": "19", "low": "18.3", "volume": "11142" },
            { "id": "272949", "company_id": "10", "date": "2014-12-22", "open": "18.5", "close": "18.9", "high": "19", "low": "18.5", "volume": "19596" },
            { "id": "155319", "company_id": "10", "date": "2014-12-21", "open": "18.3", "close": "18.7", "high": "19", "low": "18.3", "volume": "9941" },
            { "id": "180174", "company_id": "10", "date": "2014-12-18", "open": "18.3", "close": "18.4", "high": "18.6", "low": "18.1", "volume": "6216" },
            { "id": "190051", "company_id": "10", "date": "2014-12-17", "open": "18.2", "close": "18.4", "high": "18.6", "low": "18.2", "volume": "5292" },
            { "id": "73750", "company_id": "10", "date": "2014-12-15", "open": "18", "close": "18.4", "high": "18.8", "low": "18", "volume": "9171" },
            { "id": "39481", "company_id": "10", "date": "2014-12-14", "open": "18", "close": "18.4", "high": "18.5", "low": "18", "volume": "3889" },
            { "id": "135833", "company_id": "10", "date": "2014-12-11", "open": "18", "close": "18.2", "high": "18.7", "low": "18", "volume": "5437" },
            { "id": "142741", "company_id": "10", "date": "2014-12-10", "open": "18.7", "close": "18.7", "high": "19", "low": "18.7", "volume": "15000" },
            { "id": "85995", "company_id": "10", "date": "2014-12-09", "open": "18.5", "close": "18.7", "high": "18.9", "low": "18.5", "volume": "2500" },
            { "id": "95439", "company_id": "10", "date": "2014-12-08", "open": "18.9", "close": "18.9", "high": "19", "low": "18.9", "volume": "9000" },
            { "id": "105196", "company_id": "10", "date": "2014-12-07", "open": "19.1", "close": "18.9", "high": "19.1", "low": "18.6", "volume": "17000" },
            { "id": "64146", "company_id": "10", "date": "2014-12-04", "open": "19.1", "close": "19.1", "high": "19.5", "low": "19", "volume": "9500" },
            { "id": "8442", "company_id": "10", "date": "2014-12-03", "open": "19.6", "close": "19.4", "high": "19.6", "low": "18.9", "volume": "16500" },
            { "id": "19979", "company_id": "10", "date": "2014-12-02", "open": "19.4", "close": "19.3", "high": "19.5", "low": "19.2", "volume": "10500" },
            { "id": "29120", "company_id": "10", "date": "2014-12-01", "open": "19.2", "close": "19.3", "high": "19.5", "low": "19.2", "volume": "22000" },
            { "id": "205805", "company_id": "10", "date": "2014-11-30", "open": "18.5", "close": "19", "high": "19.2", "low": "18.5", "volume": "8500" },
            { "id": "231264", "company_id": "10", "date": "2014-11-27", "open": "18.6", "close": "18.6", "high": "18.8", "low": "18.6", "volume": "4500" },
            { "id": "241709", "company_id": "10", "date": "2014-11-26", "open": "18.4", "close": "18.4", "high": "18.5", "low": "18.4", "volume": "10500" },
            { "id": "249698", "company_id": "10", "date": "2014-11-25", "open": "19.3", "close": "18.5", "high": "19.3", "low": "18.4", "volume": "19000" },
            { "id": "256312", "company_id": "10", "date": "2014-11-24", "open": "18.4", "close": "18.5", "high": "19.4", "low": "18.4", "volume": "10500" },
            { "id": "265701", "company_id": "10", "date": "2014-11-23", "open": "18.8", "close": "18.4", "high": "18.8", "low": "18.3", "volume": "9000" },
            { "id": "163888", "company_id": "10", "date": "2014-11-20", "open": "19", "close": "18.9", "high": "19.4", "low": "18.8", "volume": "2500" },
            { "id": "172132", "company_id": "10", "date": "2014-11-19", "open": "19", "close": "19", "high": "19.3", "low": "18.9", "volume": "10500" },
            { "id": "181713", "company_id": "10", "date": "2014-11-18", "open": "19", "close": "18.8", "high": "19", "low": "18.5", "volume": "7000" },
            { "id": "190867", "company_id": "10", "date": "2014-11-17", "open": "18.9", "close": "19", "high": "19.3", "low": "18.9", "volume": "12500" },
            { "id": "112749", "company_id": "10", "date": "2014-11-16", "open": "19", "close": "19", "high": "19.3", "low": "18.9", "volume": "61500" },
            { "id": "6305", "company_id": "10", "date": "2014-11-13", "open": "19.3", "close": "19.1", "high": "19.7", "low": "18.9", "volume": "71500" },
            { "id": "127950", "company_id": "10", "date": "2014-11-12", "open": "19.3", "close": "19.1", "high": "19.8", "low": "19.1", "volume": "88500" },
            { "id": "137829", "company_id": "10", "date": "2014-11-11", "open": "19.2", "close": "19.4", "high": "19.7", "low": "19.2", "volume": "8500" },
            { "id": "143860", "company_id": "10", "date": "2014-11-10", "open": "19.3", "close": "19.4", "high": "19.8", "low": "19.3", "volume": "26500" },
            { "id": "87289", "company_id": "10", "date": "2014-11-09", "open": "19.7", "close": "19.5", "high": "19.7", "low": "19.4", "volume": "17000" },
            { "id": "46934", "company_id": "10", "date": "2014-11-06", "open": "19.5", "close": "19.8", "high": "20", "low": "19.5", "volume": "17500" },
            { "id": "55737", "company_id": "10", "date": "2014-11-05", "open": "19.5", "close": "19.7", "high": "20.4", "low": "19.5", "volume": "19000" },
            { "id": "9385", "company_id": "10", "date": "2014-11-03", "open": "19.6", "close": "19.9", "high": "20.5", "low": "19.6", "volume": "26000" },
            { "id": "21053", "company_id": "10", "date": "2014-11-02", "open": "19.5", "close": "19.6", "high": "20.1", "low": "19.5", "volume": "35500" },
            { "id": "206623", "company_id": "10", "date": "2014-10-30", "open": "20.1", "close": "20.1", "high": "20.1", "low": "20.1", "volume": "26500" },
            { "id": "215378", "company_id": "10", "date": "2014-10-29", "open": "20.1", "close": "20.1", "high": "20.2", "low": "20", "volume": "18000" },
            { "id": "223801", "company_id": "10", "date": "2014-10-28", "open": "21", "close": "20.2", "high": "21", "low": "20.2", "volume": "15000" },
            { "id": "233072", "company_id": "10", "date": "2014-10-27", "open": "19.8", "close": "20.3", "high": "20.7", "low": "19.8", "volume": "16000" },
            { "id": "242748", "company_id": "10", "date": "2014-10-26", "open": "20.2", "close": "20", "high": "20.2", "low": "19.9", "volume": "12000" },
            { "id": "266222", "company_id": "10", "date": "2014-10-23", "open": "20.6", "close": "20.3", "high": "20.6", "low": "20.3", "volume": "55000" },
            { "id": "275000", "company_id": "10", "date": "2014-10-22", "open": "21.3", "close": "20.7", "high": "21.3", "low": "20.5", "volume": "31500" },
            { "id": "156482", "company_id": "10", "date": "2014-10-21", "open": "21.1", "close": "21.2", "high": "21.5", "low": "20.9", "volume": "14500" },
            { "id": "151061", "company_id": "10", "date": "2014-10-20", "open": "21.7", "close": "20.7", "high": "21.7", "low": "20.2", "volume": "70000" },
            { "id": "173437", "company_id": "10", "date": "2014-10-19", "open": "21.6", "close": "21.3", "high": "21.9", "low": "21.1", "volume": "30000" },
            { "id": "113145", "company_id": "10", "date": "2014-10-16", "open": "22.2", "close": "21.9", "high": "22.2", "low": "21.7", "volume": "111000" },
            { "id": "74650", "company_id": "10", "date": "2014-10-15", "open": "22.8", "close": "22.2", "high": "22.9", "low": "22.1", "volume": "77500" },
            { "id": "41480", "company_id": "10", "date": "2014-10-14", "open": "22.5", "close": "22.8", "high": "23", "low": "21.5", "volume": "131000" },
            { "id": "7349", "company_id": "10", "date": "2014-10-13", "open": "22.9", "close": "22.2", "high": "23", "low": "21.5", "volume": "91000" },
            { "id": "128871", "company_id": "10", "date": "2014-10-12", "open": "21.9", "close": "22.6", "high": "22.6", "low": "21", "volume": "168500" },
            { "id": "20406", "company_id": "10", "date": "2014-10-02", "open": "19.3", "close": "20.6", "high": "21", "low": "19.3", "volume": "194000" },
            { "id": "30416", "company_id": "10", "date": "2014-10-01", "open": "19", "close": "19.3", "high": "19.5", "low": "19", "volume": "61000" },
            { "id": "207706", "company_id": "10", "date": "2014-09-30", "open": "18.5", "close": "18.6", "high": "18.9", "low": "18.5", "volume": "52000" },
            { "id": "215808", "company_id": "10", "date": "2014-09-29", "open": "18.6", "close": "18.5", "high": "18.7", "low": "18.5", "volume": "21000" },
            { "id": "224707", "company_id": "10", "date": "2014-09-28", "open": "18.8", "close": "18.5", "high": "19", "low": "18.5", "volume": "62000" },
            { "id": "251154", "company_id": "10", "date": "2014-09-25", "open": "19", "close": "18.6", "high": "19.1", "low": "18.5", "volume": "71000" },
            { "id": "256964", "company_id": "10", "date": "2014-09-24", "open": "19.7", "close": "18.9", "high": "19.7", "low": "18.7", "volume": "37500" },
            { "id": "275395", "company_id": "10", "date": "2014-09-22", "open": "18.8", "close": "18.9", "high": "19.2", "low": "18.6", "volume": "107500" },
            { "id": "157434", "company_id": "10", "date": "2014-09-21", "open": "18.2", "close": "18.7", "high": "18.9", "low": "18.2", "volume": "81500" },
            { "id": "183032", "company_id": "10", "date": "2014-09-18", "open": "18", "close": "18.5", "high": "18.8", "low": "17.9", "volume": "90500" },
            { "id": "193078", "company_id": "10", "date": "2014-09-17", "open": "17.8", "close": "18", "high": "18.3", "low": "17.8", "volume": "77500" },
            { "id": "113961", "company_id": "10", "date": "2014-09-16", "open": "18.3", "close": "18", "high": "18.4", "low": "17.9", "volume": "78000" },
            { "id": "75861", "company_id": "10", "date": "2014-09-15", "open": "19", "close": "18.2", "high": "19", "low": "18", "volume": "211500" },
            { "id": "42657", "company_id": "10", "date": "2014-09-14", "open": "19", "close": "19.1", "high": "19.2", "low": "18.9", "volume": "21000" },
            { "id": "138528", "company_id": "10", "date": "2014-09-11", "open": "19.3", "close": "19.1", "high": "19.5", "low": "19", "volume": "10000" },
            { "id": "144798", "company_id": "10", "date": "2014-09-10", "open": "19.2", "close": "19.2", "high": "19.7", "low": "19.1", "volume": "175500" }]

        let candleOhlcMappings = [];
        
        let info = {
            yMin: [],
            xMin: [],
            yMax: [],
            xMax: [],
            l: 0,
            h: 0,
            minDate: "",
            maxDate: "",
        }
        let w = window.innerWidth - 30;
        let h = window.innerHeight - 30;

        let canvas = document.getElementById("canvas");
        canvas.width = w;
        canvas.height = h;

        let ctx = canvas.getContext("2d");
        let centerPoint = [w / 2, h / 2];
        let boundaries = [w - 50, h - 50];

        //amount of grid lines to evenly distribute for each axis
        var xLines = 40;    
        var yLines = 100;
        
        ohlc = []
        for (const item of data) {
            ohlc.push([item.date, item.open, item.low, item.close, item.high])
        }
        //set max/min date
        dateRange = [ohlc[0][0], ohlc[ohlc.length - 1][0]]
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, w, h);
        // ctx.fillStyle = "black";
        // ctx.fillRect(0, 0, w, h)
        let steps = drawGrid(ctx, 100, 100, xLines, lp, hp [100, 100], info);
        drawCandles(ohlc, dateRange, lp, hp, steps)
        // var dataUri = canvas.toDataURL();
        // console.log(dataUri)
    })();

    console.log("---")
</script>

</html>